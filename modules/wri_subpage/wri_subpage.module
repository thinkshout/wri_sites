<?php

/**
 * @file
 * Subpage module hook implementations.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\menu_link_content\Entity\MenuLinkContent;

/**
 * Implements hook_ENTITY_TYPE_insert().
 */
//function wri_subpage_node_insert(EntityInterface $entity) {
//  wri_subpage_node_update($entity);
//}

/**
 * Implements hook_ENTITY_TYPE_update().
 */
//function wri_subpage_node_update(EntityInterface $entity) {
//  if (isset($entity->field_parent_page)) {
//    $parent = $entity->field_parent_page->entity;
//    if ($parent && $parent->id()) {
//      // Set the correct menu for microsites vs all others.
//      'microsite' == $parent->bundle() ? $menu_name = 'microsites' : $menu_name = 'page-hierarchies';
//      $menu_link_manager = \Drupal::service('plugin.manager.menu.link');
//
//      // Save the parent at the root of the menu, if not already there.
//      $parent_link_menu_id = array_key_first($menu_link_manager->loadLinksByRoute('entity.node.canonical', ['node' => $parent->id()], $menu_name));
//      if (!$parent_link_menu_id) {
//        $parent_link_menu = MenuLinkContent::create([
//          'title' => $parent->label(),
//          'link' => ['uri' => 'entity:node/' . $parent->id()],
//          'menu_name' => $menu_name,
//          'expanded' => TRUE,
//        ]);
//        $parent_link_menu->save();
//        $parent_link_menu_id = $parent_link_menu->getPluginId();
//      }
//
//      // Save the current page as a child of the parent in the appropriate menu.
//      $current_link_menu_menu = $menu_link_manager->loadLinksByRoute('entity.node.canonical', ['node' => $entity->id()], $menu_name);
//      if (!$current_link_menu_menu && !$entity->original) {
//        // Create a new menu link, but only if this is a new node. Otherwise
//        // clicking "Provide a menu link" to "Off" does not stick.
//        $current_link_menu = MenuLinkContent::create([
//          'title' => $entity->label(),
//          'link' => ['uri' => 'entity:node/' . $entity->id()],
//          'menu_name' => $menu_name,
//          'parent' => $parent_link_menu_id,
//          'expanded' => TRUE,
//        ]);
//      }
//      elseif ($current_link_menu_menu) {
//        $current_link_menu_id = current($current_link_menu_menu)->getPluginDefinition()["metadata"]["entity_id"];
//        $current_link_menu = MenuLinkContent::load($current_link_menu_id);
//        $current_link_menu->set('enabled', 1);
//        $current_link_menu->set('parent', $parent_link_menu_id);
//      }
//      if (isset($current_link_menu)) {
//        $current_link_menu->save();
//      }
//    }
//  }
//}

/**
 * Implements hook_form_BASE_FORM_ID_alter() for \Drupal\node\NodeForm.
 */
function wri_subpage_form_node_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $node = $form_state->getFormObject()->getEntity();
  if ($form['menu']['enabled']['#default_value'] === 0 && isset($node->field_parent_page->target_id)) {
    $parent = $node->field_parent_page->entity;
    if ($parent && $parent->id()) {
      // Set the correct menu for microsites vs all others.
      'microsite' == $parent->bundle() ? $menu_name = 'microsites' : $menu_name = 'page-hierarchies';
      $menu_link_manager = \Drupal::service('plugin.manager.menu.link');
      $parent_link_menu_id = array_key_first($menu_link_manager->loadLinksByRoute('entity.node.canonical', ['node' => $parent->id()], $menu_name));
      $form['menu']['link']['menu_parent']['#default_value'] = $menu_name . ':' . $parent_link_menu_id;
      $form['menu']['link']['menu_parent']['#description'] = t('Parent suggestion set from the "Parent page" field.');
    }
  }
  $position = array_search('menu_ui_form_node_form_submit', $form['actions']['submit']['#submit']);
  array_splice($form['actions']['submit']['#submit'], 4, 0, 'wri_subpage_set_menu');
}

function wri_subpage_set_menu(array &$form, FormStateInterface $form_state) {
  $entity = $form_state->getFormObject()->getEntity();
  if ($entity->isNew()) {
    $parent = $entity->field_parent_page->entity;
    if ($parent && $parent->id()) {
      // Set the correct menu for microsites vs all others.
      'microsite' == $parent->bundle() ? $menu_name = 'microsites' : $menu_name = 'page-hierarchies';
      $menu_link_manager = \Drupal::service('plugin.manager.menu.link');

      // Save the parent at the root of the menu, if not already there.
      $parent_link_menu_id = array_key_first($menu_link_manager->loadLinksByRoute('entity.node.canonical', ['node' => $parent->id()], $menu_name));
      if (!$parent_link_menu_id) {
        $parent_link_menu = MenuLinkContent::create([
          'title' => $parent->label(),
          'link' => ['uri' => 'entity:node/' . $parent->id()],
          'menu_name' => $menu_name,
          'expanded' => TRUE,
        ]);
        $parent_link_menu->save();
        $parent_link_menu_id = $parent_link_menu->getPluginId();
      }

      $form_state->setValue('menu', [
        'enabled' => TRUE,
        'entity_id' => $entity->id(),
        'title' => $entity->label(),
        'parent' => $parent_link_menu_id,
        'menu_name' => $menu_name,
      ]);
    }
  }
}
