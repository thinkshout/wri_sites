<?php

/**
 * @file
 * WRI SEO related hooks.
 */

/**
 * Implements hook_page_attachments().
 */
function wri_seo_page_attachments(array &$attachments) {
  $attachments['#attached']['library'][] = 'wri_seo/wri-seo';
  $node = \Drupal::request()->attributes->get('node');
  $admin = \Drupal::service('router.admin_context')->isAdminRoute();
  if ($node && !$admin) {
    $attachments['#attached']['drupalSettings']['wri_seo']['node_type'] = $node->bundle();
    $topic = $node->field_primary_topic ? $node->field_primary_topic->entity : NULL;
    $type = $node->field_type ? $node->field_type->entity : NULL;

    switch ($node->bundle()) {
      case 'article':
        $article_details = [
          'insights topic' => $topic ? $topic->get('name')->getString() : '',
          'insights region' => '',
          'insights type' => $type ? $type->get('name')->getString() : '',
          'insights publish date' => date('Y-m-d', $node->getCreatedTime()),
          'primary topic' => $topic ? $topic->get('name')->getString() : '',
        ];
        $attachments['#attached']['drupalSettings']['wri_seo']['article_details'] = $article_details;
        break;

      case 'project_detail':
        $project_details = [
          'project topic' => $topic ? $topic->get('name')->getString() : '',
          'primary topic' => $topic ? $topic->get('name')->getString() : '',
        ];
        $attachments['#attached']['drupalSettings']['wri_seo']['project_details'] = $project_details;
        break;

      default:
        $default_details = [
          'primary topic' => $topic ? $topic->get('name')->getString() : '',
        ];
        $attachments['#attached']['drupalSettings']['wri_seo']['default_details'] = $default_details;
        break;

    }

    // Check for Flourish embeds.
    if ($node->hasField('body') && !$node->get('body')->isEmpty()) {
      $body = $node->get('body')->value;
      preg_match_all('/<drupal-media.*?data-entity-uuid="(.*?)".*?>/', $body, $matches);

      if (!empty($matches[1])) {
        foreach ($matches[1] as $uuid) {
          // Load the media entity by UUID.
          $media = \Drupal::service('entity.repository')->loadEntityByUuid('media', $uuid);

          if ($media && $media->bundle() === 'embed') {
            $source = $media->get('field_media_embed_code')->value;

            if (strpos($source, 'flourish-embed') !== FALSE) {
              $module_path = \Drupal::service('extension.path.resolver')->getPath('module', 'wri_seo');

              // Add custom Flourish analytics script inline.
              $script_path = $module_path . '/js/flourish_analytics.js';
              if (file_exists($script_path)) {
                $attachments['#attached']['html_head'][] = [
                  [
                    '#tag' => 'script',
                    '#attributes' => ['type' => 'text/javascript'],
                    '#value' => file_get_contents($script_path),
                  ],
                  'flourish_analytics',
                ];
              }
              else {
                \Drupal::logger('wri_seo')->warning('Flourish analytics script not found at @path', ['@path' => $script_path]);
              }
              break;
            }
          }
        }
      }
    }
  }

  // Exclude certain paths from crawlers per WRIN issue #323.
  $current_path = \Drupal::service('path.current')->getPath();

  $noindex = [
    '/project-resources/',
    '/project-experts/',
  ];

  foreach ($noindex as $index) {
    if (substr($current_path, 0, strlen($index)) === $index) {
      $metatag = [
        '#tag' => 'meta',
        '#attributes' => [
          'name' => 'robots',
          'content' => 'noindex, nofollow',
        ],
      ];

      $attachments['#attached']['html_head'][] = [$metatag, 'robots'];
      break;
    }
  }

}
